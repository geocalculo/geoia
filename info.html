<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIA - Reporte del punto consultado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: #f4f5f7;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Helvetica, Arial, sans-serif;
    }
    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 32px 32px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    h1 { margin: 0 0 4px; font-size: 24px; }
    .subtitle {
      margin: 0 0 24px;
      font-size: 14px;
      color: #6b7280;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .stat-label {
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }
    h2 { font-size: 18px; margin: 20px 0 6px; }
    .section-text {
      font-size: 13px;
      color: #6b7280;
      margin: 0 0 12px;
    }
    #map {
      width: 100%;
      height: 360px;
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    #prc-container {
      margin-top: 8px;
      font-size: 14px;
    }
    #prc-container table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 6px;
    }
    #prc-container th,
    #prc-container td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      font-size: 12px;
    }
    #prc-container th {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>GeoIA - Reporte del punto consultado</h1>
    <p class="subtitle">
      Reporte generado a partir del punto seleccionado en el visor principal.
      Incluye coordenadas en WGS84, UTM 19S (EPSG:32719) y evaluación del punto
      sobre los polígonos del archivo <code>capas/IPT_03_PRC_Copiapo.kml</code>.
    </p>

    <div class="stats">
      <div class="stat-box">
        <div class="stat-label">Latitud (WGS84)</div>
        <div class="stat-value" id="lat-wgs84">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Longitud (WGS84)</div>
        <div class="stat-value" id="lon-wgs84">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Este (UTM 19S, m)</div>
        <div class="stat-value" id="utm-e">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Norte (UTM 19S, m)</div>
        <div class="stat-value" id="utm-n">-</div>
      </div>
    </div>

    <h2>Mapa de referencia</h2>
    <p class="section-text">
      Vista centrada en el punto consultado. El marcador indica la ubicación de la consulta.
      El polígono del PRC que contenga el punto se dibuja sobre este mapa.
    </p>
    <div id="map"></div>

    <h2>Consulta PRC (punto sobre polígonos)</h2>
    <p class="section-text">
      Evaluación del punto sobre los polígonos del archivo
      <code>IPT_03_PRC_Copiapo.kml</code>. El algoritmo es robusto para polígonos
      cóncavos (por ejemplo con forma de herradura) y considera además una
      pequeña tolerancia alrededor del punto para bordes.
    </p>
    <div id="prc-container">
      Cargando consulta PRC...
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    function getParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const lat = parseFloat(getParam('lat'));
    const lon = parseFloat(getParam('lon'));

    if (!isNaN(lat) && !isNaN(lon)) {
      document.getElementById('lat-wgs84').textContent = lat.toFixed(6);
      document.getElementById('lon-wgs84').textContent = lon.toFixed(6);
    }

    proj4.defs('EPSG:32719',
      '+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs'
    );

    if (!isNaN(lat) && !isNaN(lon)) {
      const utm = proj4('EPSG:4326', 'EPSG:32719', [lon, lat]);
      const este = utm[0];
      const norte = utm[1];
      document.getElementById('utm-e').textContent = este.toFixed(3);
      document.getElementById('utm-n').textContent = norte.toFixed(3);
    }

    var map = L.map('map').setView([lat, lon], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var marker = L.marker([lat, lon]).addTo(map);
    marker.bindPopup(
      'Punto consultado<br>Lat: ' + lat.toFixed(6) +
      '<br>Lon: ' + lon.toFixed(6)
    ).openPopup();

    // ---- LÓGICA PRC DIRECTA SOBRE IPT_03_PRC_Copiapo.kml ----

    function nombrePoligono(props) {
      if (!props) return 'Polígono sin nombre';
      return props.name ||
             props.Nombre ||
             props.NOMBRE ||
             props.ZONA ||
             props.Zona ||
             props.CODIGO ||
             JSON.stringify(props);
    }

    function consultarPRC(lat, lon) {
      return new Promise(function(resolve, reject) {
        var loader = omnivore.kml('capas/IPT_03_PRC_Copiapo.kml');

        loader.on('ready', function() {
          try {
            var geojson = this.toGeoJSON();
            var features = geojson.features || [];
            var pt = turf.point([lon, lat]);

            var resultados = [];

            for (var i = 0; i < features.length; i++) {
              var f = features[i];
              if (!f.geometry) continue;

              var t = f.geometry.type;
              if (t !== 'Polygon' && t !== 'MultiPolygon') continue;

              var dentro = false;
              try {
                // 1) prueba exacta punto-en-polígono (cóncavos y herradura OK)
                dentro = turf.booleanPointInPolygon(pt, f);
              } catch (e) {
                console.warn('Error booleanPointInPolygon', e);
              }

              // 2) Si no está dentro, aplicamos una pequeña tolerancia (~2 m)
              if (!dentro) {
                try {
                  var buf = turf.buffer(pt, 0.002, { units: 'kilometers' }); // ~2 m
                  dentro = turf.booleanIntersects(buf, f);
                } catch (e2) {
                  console.warn('Error en buffer/intersects', e2);
                }
              }

              if (dentro) {
                resultados.push({
                  feature: f,
                  props: f.properties || {},
                  nombre: nombrePoligono(f.properties || {})
                });
              }
            }

            resolve(resultados);
          } catch (e) {
            reject(e);
          }
        });

        loader.on('error', function(err) {
          reject(err);
        });
      });
    }

    function construirHTML(resultados) {
      var html = '<section><h3>Consulta PRC sobre IPT_03_PRC_Copiapo.kml</h3>';

      if (!resultados || resultados.length === 0) {
        html += '<p>El punto consultado <strong>no se encuentra dentro de ningún polígono</strong> del archivo PRC.</p>';
        html += '</section>';
        return html;
      }

      html += '<p>Se encontraron las siguientes coincidencias:</p>';

      resultados.forEach(function(r, idx) {
        html += '<p style="margin:4px 0;"><strong>Polígono ' + (idx + 1) +
                ':</strong> ' + r.nombre + '</p>';

        var props = r.props || {};
        var keys = Object.keys(props);
        if (keys.length > 0) {
          html += '<table><tr><th>Atributo</th><th>Valor</th></tr>';
          keys.forEach(function(k) {
            html += '<tr><td>' + k + '</td><td>' + props[k] + '</td></tr>';
          });
          html += '</table>';
        }
      });

      html += '</section>';
      return html;
    }

    if (!isNaN(lat) && !isNaN(lon)) {
      consultarPRC(lat, lon)
        .then(function(resultados) {
          // dibujar polígonos en el mapa
          resultados.forEach(function(r) {
            try {
              L.geoJSON(r.feature, {
                style: {
                  color: '#2563eb',
                  weight: 2,
                  fillOpacity: 0.2
                }
              }).addTo(map);
            } catch (e) {
              console.warn('Error al dibujar polígono', e);
            }
          });

          document.getElementById('prc-container').innerHTML =
            construirHTML(resultados);
        })
        .catch(function(err) {
          console.error('Error en consulta PRC:', err);
          document.getElementById('prc-container').innerHTML =
            '<section><h3>Consulta PRC</h3><p>Error al procesar el archivo KML.</p></section>';
        });
    } else {
      document.getElementById('prc-container').innerHTML =
        '<section><h3>Consulta PRC</h3><p>No se recibieron coordenadas válidas.</p></section>';
    }
  </script>
</body>
</html>
