<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIA - Mapa de consulta PRC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Helvetica, Arial, sans-serif;
      background: #0b1120;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #020617;
      border-bottom: 1px solid #111827;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
    }

    .brand-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .select-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .select-label {
      font-size: 11px;
      color: #9ca3af;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 30px 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .select-wrapper::after {
      content: "▾";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #9ca3af;
      pointer-events: none;
    }

    .hint {
      font-size: 10px;
      color: #6b7280;
    }

    main {
      flex: 1;
      min-height: 0;
    }

    #map {
      width: 100%;
      height: calc(100vh - 64px);
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      #map {
        height: calc(100vh - 88px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span class="brand-title">GeoIA - Mapa de consulta PRC</span>
      <span class="brand-subtitle">
        Mapa limpio. Clic en cualquier punto para abrir el detalle en una pestaña nueva.
      </span>
    </div>

    <div class="toolbar">
      <div class="select-wrapper">
        <span class="select-label">Instrumento:</span>
        <select id="instrumento-select">
          <option value="">— Selecciona PRC/SCC —</option>
          <option value="PRC_COPIAPO">PRC Comunal Copiapó</option>
          <option value="PRC_CALDERA">PRC Comunal Caldera</option>
          <option value="PRC_CHAÑARAL">PRC Comunal Chañaral</option>
          <option value="PRC_DIEGO_ALMAGRO">PRC Comunal Diego de Almagro</option>
          <option value="PRC_FREIRINA">PRC Comunal Freirina</option>
          <option value="PRC_HUASCO">PRC Comunal Huasco</option>
          <option value="PRC_VALLENAR">PRC Comunal Vallenar</option>
          <option value="SCC_ELSALADO">SCC El Salado</option>
          <option value="SCC_FLAMENCO">SCC Flamenco</option>
          <option value="SCC_PORTOFINO">SCC Flamenco</option>
          <option value="SCC_PORTOFINO">SCC Portofino</option>
          <option value="PRICOST">PRC Intercomunal Costero de Atacama</option>
        </select>
      </div>
      <div class="hint">
        Selecciona un instrumento para hacer zoom a la extensión completa de su KML.
      </div>
    </div>
  </header>

  <main>
    <div id="map"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    // Vista inicial: Copiapó al centro, zoom medio (~1:100.000)
    var map = L.map('map').setView([-27.37, -70.33], 10);

    // Capas base
    var capaMapa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    });

    var capaSatelite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Imagery © Esri'
      }
    );

    // Leer preferencia de mapa base desde localStorage (si existe)
    var baseChoice = null;
    try {
      baseChoice = localStorage.getItem('geoia_baseLayer');
    } catch (e) {
      baseChoice = null;
    }

    if (baseChoice === 'satelital') {
      capaSatelite.addTo(map);
    } else {
      capaMapa.addTo(map);
    }

    // Control de capas (Mapa / Satelital)
    L.control.layers(
      {
        'Mapa': capaMapa,
        'Satelital': capaSatelite
      },
      null,
      { position: 'topright' }
    ).addTo(map);

    // Guardar preferencia cuando el usuario cambia el mapa base
    map.on('baselayerchange', function (e) {
      try {
        if (e.name === 'Mapa') {
          localStorage.setItem('geoia_baseLayer', 'mapa');
        } else if (e.name === 'Satelital') {
          localStorage.setItem('geoia_baseLayer', 'satelital');
        }
      } catch (err) {
        console.warn('No se pudo guardar la preferencia de mapa base:', err);
      }
    });

    // Definición de instrumentos (solo para zoom por extensión KML)
    var INSTRUMENTOS = {
      'PRC_COPIAPO':      { nombre: 'PRC Comunal Copiapó',                 archivo: 'capas/IPT_03_PRC_Copiapo.kml',         bounds: null },
      'PRC_CALDERA':      { nombre: 'PRC Comunal Caldera',                 archivo: 'capas/IPT_03_PRC_Caldera.kml',         bounds: null },
      'PRC_CHAÑARAL':     { nombre: 'PRC Comunal Chañaral',                archivo: 'capas/IPT_03_PRC_Chañaral.kml',        bounds: null },
      'PRC_DIEGO_ALMAGRO':{ nombre: 'PRC Comunal Diego de Almagro',        archivo: 'capas/IPT_03_PRC_Diego_de_Almagro.kml',bounds: null },
      'PRC_FREIRINA':     { nombre: 'PRC Comunal Freirina',                archivo: 'capas/IPT_03_PRC_Freirina.kml',        bounds: null },
      'PRC_HUASCO':       { nombre: 'PRC Comunal Huasco',                  archivo: 'capas/IPT_03_PRC_Huasco.kml',          bounds: null },
      'PRC_VALLENAR':     { nombre: 'PRC Comunal Vallenar',                archivo: 'capas/IPT_03_PRC_Vallenar.kml',        bounds: null },
      'SCC_ELSALADO':     { nombre: 'SCC El Salado',                       archivo: 'capas/IPT_03_SCC_ElSalado.kml',        bounds: null },
      'SCC_FLAMENCO':     { nombre: 'SCC Flamenco',                        archivo: 'capas/IPT_03_SCC_Flamenco.kml',        bounds: null },
      'SCC_PORTOFINO':    { nombre: 'SCC Portofino',                       archivo: 'capas/IPT_03_SCC_Portofino.kml',       bounds: null },
      'PRICOST':          { nombre: 'PRC Intercomunal Costero de Atacama', archivo: 'capas/PRICOST_Atacama.kml',            bounds: null }
    };

    // Función para hacer zoom a un instrumento
    function zoomInstrumento(id) {
      var cfg = INSTRUMENTOS[id];
      if (!cfg) return;

      // Si ya tenemos bounds calculados, usamos esos
      if (cfg.bounds) {
        map.fitBounds(cfg.bounds, { padding: [20, 20] });
        return;
      }

      // Cargar KML *solo* para obtener sus bounds
      try {
        var loader = omnivore.kml(cfg.archivo);

        // No queremos ver la capa; la agregamos con estilo transparente
        loader.on('ready', function () {
          try {
            loader.addTo(map);
            if (loader.setStyle) {
              loader.setStyle({ opacity: 0, fillOpacity: 0 });
            }
            cfg.bounds = loader.getBounds();
            map.fitBounds(cfg.bounds, { padding: [20, 20] });
          } catch (e) {
            console.warn('No fue posible obtener bounds para', cfg.nombre, e);
          } finally {
            map.removeLayer(loader);
          }
        });

        loader.on('error', function (err) {
          console.warn('Error cargando KML de', cfg.nombre, err);
        });
      } catch (e) {
        console.warn('Error creando loader KML para', cfg.nombre, e);
      }
    }

    // Manejo del menú desplegable
    var selectInstrumento = document.getElementById('instrumento-select');
    selectInstrumento.addEventListener('change', function () {
      var id = this.value;
      if (!id) return;
      zoomInstrumento(id);
    });

    // Clic en mapa: abre info.html en pestaña nueva con el punto consultado
    map.on('click', function (e) {
      var lat = e.latlng.lat;
      var lon = e.latlng.lng;
      var url = 'info.html?lat=' + encodeURIComponent(lat) +
                '&lon=' + encodeURIComponent(lon);
      window.open(url, '_blank');
    });
  </script>
</body>
</html>
