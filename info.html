<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GeoIA - Reporte del punto consultado</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<style>
body{font-family:Arial;padding:20px;background:#f5f6fa;}
.card{background:white;padding:20px;border-radius:10px;max-width:900px;margin:auto;}
</style>
</head>
<body>
<div class="card">
<h2>GeoIA - Reporte del punto consultado</h2>
<div id="coords"></div>
<h3>Mapa de referencia</h3>
<div id="map" style="height:300px"></div>
<h3>Distancias a puntos</h3>
<table border="1" cellpadding="5" id="tablaPuntos"></table>
<h3>Distancias a líneas</h3>
<table border="1" cellpadding="5" id="tablaLineas"></table>
<h3>PRC Copiapó</h3>
<div id="prc"></div>
</div>

<script>
function getParam(n){return new URLSearchParams(window.location.search).get(n);}
const lat=parseFloat(getParam('lat'));
const lon=parseFloat(getParam('lon'));
document.getElementById('coords').innerHTML = "LAT: "+lat+"<br>LON:"+lon;

var map=L.map('map').setView([lat,lon],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([lat,lon]).addTo(map);

// cargar puntos
omnivore.kml('capas/puntos_a_consultar.kml').on('ready',function(){
  var feats=this.toGeoJSON().features;
  var html="<tr><th>#</th><th>Nombre</th><th>Lat</th><th>Lon</th><th>Dist(m)</th></tr>";
  feats.forEach((f,i)=>{
    var d=turf.distance(turf.point([lon,lat]), turf.point(f.geometry.coordinates),{units:'meters'});
    html+=`<tr><td>${i+1}</td><td>${f.properties.name||'-'}</td><td>${f.geometry.coordinates[1]}</td><td>${f.geometry.coordinates[0]}</td><td>${d.toFixed(1)}</td></tr>`;
  });
  document.getElementById('tablaPuntos').innerHTML=html;
});

// cargar lineas
omnivore.kml('capas/lineas_a_consultar.kml').on('ready',function(){
  var feats=this.toGeoJSON().features;
  var html="<tr><th>#</th><th>Nombre</th><th>Dist(m)</th></tr>";
  feats.forEach((f,i)=>{
    var d=turf.pointToLineDistance(turf.point([lon,lat]), f,{units:'meters'});
    html+=`<tr><td>${i+1}</td><td>${f.properties.name||'-'}</td><td>${d.toFixed(1)}</td></tr>`;
  });
  document.getElementById('tablaLineas').innerHTML=html;
});

// cargar PRC
omnivore.kml('capas/IPT_03_PRC_Copiapo.kml').on('ready',function(){
  var feats=this.toGeoJSON().features;
  var pt=turf.point([lon,lat]);
  var res="No cae en ningún polígono";
  feats.forEach(f=>{
    if(f.geometry.type==='Polygon' || f.geometry.type==='MultiPolygon'){
      if(turf.booleanPointInPolygon(pt,f)){
        res="Cae en: "+(f.properties.name||JSON.stringify(f.properties));
      }
    }
  });
  document.getElementById('prc').innerHTML=res;
});
</script>
</body>
</html>
