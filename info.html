<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GeoIA - Reporte del punto consultado (4 PRC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: #f4f5f7;
      font-family: system-ui, sans-serif;
    }
    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 32px 32px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    h1 { margin: 0 0 4px; font-size: 24px; }
    .subtitle { font-size: 14px; color: #6b7280; margin-bottom: 24px; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .stat-label {
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    #map {
      width: 100%;
      height: 360px;
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 6px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      font-size: 12px;
    }
    th { background: #f3f4f6; }
  </style>
</head>
<body>

  <div class="card">
    <h1>GeoIA - Reporte del punto consultado</h1>
    <p class="subtitle">
      Incluye coordenadas en WGS84, UTM 19S y análisis sobre los instrumentos:
      <br>
      <b>IPT_03_PRC_Copiapo.kml, IPT_03_PRC_Caldera.kml, IPT_03_PRC_Chañaral.kml y PRICOST_Atacama.kml</b>
    </p>

    <div class="stats">
      <div class="stat-box"><div class="stat-label">Latitud</div><div class="stat-value" id="lat-wgs84">-</div></div>
      <div class="stat-box"><div class="stat-label">Longitud</div><div class="stat-value" id="lon-wgs84">-</div></div>
      <div class="stat-box"><div class="stat-label">Este UTM</div><div class="stat-value" id="utm-e">-</div></div>
      <div class="stat-box"><div class="stat-label">Norte UTM</div><div class="stat-value" id="utm-n">-</div></div>
    </div>

    <h2>Mapa de referencia</h2>
    <div id="map"></div>

    <h2>Consulta PRC (4 instrumentos)</h2>
    <div id="prc-container">Procesando...</div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

const lat = parseFloat(getParam("lat"));
const lon = parseFloat(getParam("lon"));

document.getElementById("lat-wgs84").textContent = lat.toFixed(6);
document.getElementById("lon-wgs84").textContent = lon.toFixed(6);

proj4.defs("EPSG:32719", "+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

const utm = proj4("EPSG:4326", "EPSG:32719", [lon, lat]);
document.getElementById("utm-e").textContent = utm[0].toFixed(3);
document.getElementById("utm-n").textContent = utm[1].toFixed(3);

// --- Mapa ---
var map = L.map("map").setView([lat, lon], 17);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);
L.marker([lat, lon]).addTo(map).bindPopup("Punto consultado").openPopup();

// --- Instrumentos PRC ---
const PRC_CAPAS = [
  { id: "COPIAPO", nombre: "PRC Copiapó", archivo: "capas/IPT_03_PRC_Copiapo.kml" },
  { id: "CALDERA", nombre: "PRC Caldera", archivo: "capas/IPT_03_PRC_Caldera.kml" },
  { id: "CHAÑARAL", nombre: "PRC Chañaral", archivo: "capas/IPT_03_PRC_Chañaral.kml" },
  { id: "PRICOST", nombre: "PRC Intercomunal Costero", archivo: "capas/PRICOST_Atacama.kml" }
];

function nombrePoligono(props) {
  return props.name || props.NOMBRE || props.ZONA || "Polígono sin nombre";
}

function consultarArchivo(lat, lon, cfg) {
  return new Promise((resolve) => {
    let capa = omnivore.kml(cfg.archivo);
    capa.on("ready", function () {
      const geojson = this.toGeoJSON();
      const pt = turf.point([lon, lat]);
      let encontrados = [];

      geojson.features.forEach(f => {
        if (!f.geometry) return;
        const tipo = f.geometry.type;
        if (tipo !== "Polygon" && tipo !== "MultiPolygon") return;

        let ok = false;
        try { ok = turf.booleanPointInPolygon(pt, f); } catch {}
        if (!ok) {
          try {
            const buf = turf.buffer(pt, 0.002, { units: "kilometers" });
            ok = turf.booleanIntersects(buf, f);
          } catch {}
        }
        if (ok) {
          encontrados.push({
            nombre: nombrePoligono(f.properties),
            props: f.properties,
            feature: f,
            instrumento: cfg.nombre
          });
        }
      });

      resolve(encontrados);
    });

    capa.on("error", () => resolve([]));
  });
}

async function ejecutarConsulta() {
  let resultados = [];
  for (let cfg of PRC_CAPAS) {
    let r = await consultarArchivo(lat, lon, cfg);
    resultados = resultados.concat(r);
  }

  let html = "";
  if (resultados.length === 0) {
    html = "<p>No se encontraron zonas PRC para este punto.</p>";
  } else {
    let agrupado = {};
    resultados.forEach(r => {
      if (!agrupado[r.instrumento]) agrupado[r.instrumento] = [];
      agrupado[r.instrumento].push(r);
    });

    Object.keys(agrupado).forEach(inst => {
      html += `<h3>${inst}</h3>`;
      agrupado[inst].forEach((item, i) => {
        html += `<p><b>Polígono ${i+1}:</b> ${item.nombre}</p>`;
        html += `<table><tr><th>Atributo</th><th>Valor</th></tr>`;
        Object.keys(item.props || {}).forEach(k => {
          html += `<tr><td>${k}</td><td>${item.props[k]}</td></tr>`;
        });
        html += "</table>";
      });
    });

    resultados.forEach(r => {
      try {
        L.geoJSON(r.feature, {
          style: { color: "#2563eb", weight: 2, fillOpacity: 0.25 }
        }).addTo(map);
      } catch {}
    });
  }

  document.getElementById("prc-container").innerHTML = html;
}

ejecutarConsulta();
</script>

</body>
</html>
